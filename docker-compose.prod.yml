# ğŸš€ í”„ë¡œë•ì…˜ìš© Docker Compose ì„¤ì •
# docker-compose -f docker-compose.yml -f docker-compose.prod.yml up ìœ¼ë¡œ ì‹¤í–‰

version: '3.8'

services:
  # PostgreSQL í”„ë¡œë•ì…˜ ì„¤ì •
  postgres:
    restart: always
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/init-db:/docker-entrypoint-initdb.d
    # í”„ë¡œë•ì…˜ì—ì„œëŠ” í¬íŠ¸ ë…¸ì¶œ ì•ˆí•¨
    ports: []

  # Redis í”„ë¡œë•ì…˜ ì„¤ì •
  redis:
    restart: always
    # í”„ë¡œë•ì…˜ì—ì„œëŠ” í¬íŠ¸ ë…¸ì¶œ ì•ˆí•¨
    ports: []
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-}

  # Kafka í”„ë¡œë•ì…˜ ì„¤ì •
  zookeeper:
    restart: always

  kafka:
    restart: always
    # í”„ë¡œë•ì…˜ì—ì„œëŠ” í¬íŠ¸ ë…¸ì¶œ ì•ˆí•¨
    ports: []

  # ë°±ì—”ë“œ í”„ë¡œë•ì…˜ ì„¤ì •
  backend:
    restart: always
    environment:
      APP_ENV: production
      DEBUG: false
      PYTHONUNBUFFERED: 1
      # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      # Redis ì„¤ì •
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      # Kafka ì„¤ì •
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      # JWT ì„¤ì •
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: HS256
      JWT_EXPIRE_MINUTES: 30
      # ì‚¬ì´ë²„ í† í° ì„¤ì •
      INITIAL_CYBER_TOKENS: 200
      # ë³¸ì‚¬ ì‚¬ì´íŠ¸ ì—°ë™ ì„¤ì •
      CORPORATE_SITE_URL: ${CORPORATE_SITE_URL}
      CORPORATE_API_KEY: ${CORPORATE_API_KEY}
    # í”„ë¡œë•ì…˜ì—ì„œëŠ” ì†ŒìŠ¤ ë§ˆìš´íŠ¸ ì•ˆí•¨
    volumes:
      - backend_logs:/app/logs
    # í”„ë¡œë•ì…˜ì—ì„œëŠ” í¬íŠ¸ ë…¸ì¶œ ì•ˆí•¨ (nginxê°€ í”„ë¡ì‹œ)
    ports: []

  # í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡œë•ì…˜ ì„¤ì •
  frontend:
    restart: always
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL}
    # í”„ë¡œë•ì…˜ì—ì„œëŠ” ì†ŒìŠ¤ ë§ˆìš´íŠ¸ ì•ˆí•¨
    volumes: []
    # í”„ë¡œë•ì…˜ì—ì„œëŠ” í¬íŠ¸ ë…¸ì¶œ ì•ˆí•¨ (nginxê°€ í”„ë¡ì‹œ)
    ports: []

  # Celery Worker í”„ë¡œë•ì…˜ ì„¤ì •
  celery-worker:
    restart: always
    environment:
      APP_ENV: production
      DEBUG: false
    volumes:
      - backend_logs:/app/logs

  # Celery Beat í”„ë¡œë•ì…˜ ì„¤ì •
  celery-beat:
    restart: always
    environment:
      APP_ENV: production
      DEBUG: false
    volumes:
      - backend_logs:/app/logs

  # Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ (í”„ë¡œë•ì…˜ ì „ìš©)
  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deployment/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deployment/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
      - frontend

volumes:
  postgres_data:
  redis_data:
  kafka_data:
  backend_logs:
