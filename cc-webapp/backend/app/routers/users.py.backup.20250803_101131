#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ‘¤ ì‚¬ìš©ì ê´€ë¦¬ API ë¼ìš°í„° (ê°•í™”ëœ ë²„ì „)
ì‚¬ìš©ì í”„ë¡œí•„, ì„¸ê·¸ë¨¼íŠ¸, ì§„í–‰ìƒí™© ê´€ë¦¬ë¥¼ ìœ„í•œ í†µí•© ì—”ë“œí¬ì¸íŠ¸
"""

from fastapi import APIRouter, De@router.delete("/account", tags=["Account Management"])
async def delete_user_account(
    db: Session = Depends(get_db),
    current_user: models.User = Depends(get_current_user)
):
    """ì‚¬ìš©ì ê³„ì • ì‚­ì œ (ì†Œí”„íŠ¸ ì‚­ì œ)"""
    try:
        # ê°„ë‹¨í•œ ì†Œí”„íŠ¸ ì‚­ì œ - ì‚¬ìš©ì ë¹„í™œì„±í™”
        user = db.query(models.User).filter(models.User.id == current_user.id).first()
        if not user:
            raise HTTPException(status_code=404, detail="ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        
        # ì‹¤ì œë¡œëŠ” is_active í•„ë“œë¥¼ Falseë¡œ ì„¤ì •í•˜ê±°ë‚˜ deleted_at íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì„¤ì •
        # ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ rankë¥¼ DELETEDë¡œ ë³€ê²½
        user.rank = "DELETED"
        db.commit()
        
        return {"message": "ê³„ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤", "user_id": current_user.id}
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"ê³„ì • ì‚­ì œ ì‹¤íŒ¨: {str(e)}"
        )eption, status
from sqlalchemy.orm import Session
from typing import List, Optional
from datetime import datetime

from .. import models
from ..database import get_db
from ..services.user_service import UserService
from ..services.user_segment_service import UserSegmentService
from ..schemas.user import (
    UserResponse, 
    UserProfileResponse, 
    UserProgressResponse, 
    UserStatisticsResponse, 
    UserSegmentResponse,
    UserUpdateRequest
)
from ..dependencies import get_current_user

router = APIRouter()

# Dependency injection
def get_user_service(db: Session = Depends(get_db)):
    return UserService(db=db)

def get_segment_service(db: Session = Depends(get_db)):
    return UserSegmentService(db=db)

@router.get("/profile", response_model=UserProfileResponse, tags=["User Profile"])
async def get_user_profile(
    db: Session = Depends(get_db),
    current_user: models.User = Depends(get_current_user)
):
    """í˜„ì¬ ì‚¬ìš©ìì˜ í”„ë¡œí•„ ì •ë³´ ì¡°íšŒ"""
    try:
        user_service = UserService(db)
        user = user_service.get_user_or_error(current_user.id)
        
        # UserProfileResponse í˜•íƒœë¡œ ë³€í™˜
        return UserProfileResponse(
            id=user.id,
            site_id=user.site_id,
            nickname=user.nickname,
            phone_number=user.phone_number,
            invite_code=user.invite_code,
            cyber_token_balance=user.cyber_token_balance,
            created_at=user.created_at,
            rank=user.rank,
            total_spent=getattr(user, 'total_spent', 0.0),
            vip_tier=getattr(user, 'vip_tier', 'STANDARD'),
            battlepass_level=getattr(user, 'battlepass_level', 1)
        )
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨: {str(e)}"
        )

@router.put("/profile", response_model=UserProfileResponse, tags=["User Profile"])
async def update_user_profile(
    update_data: UserUpdateRequest,
    db: Session = Depends(get_db),
    current_user: models.User = Depends(get_current_user)
):
    """ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´ ì—…ë°ì´íŠ¸"""
    try:
        # ê°„ë‹¨í•œ ì—…ë°ì´íŠ¸ ë¡œì§
        user = db.query(models.User).filter(models.User.id == current_user.id).first()
        if not user:
            raise HTTPException(status_code=404, detail="ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        
        if update_data.nickname:
            user.nickname = update_data.nickname
        if update_data.phone_number:
            user.phone_number = update_data.phone_number
            
        db.commit()
        db.refresh(user)
        
        # UserProfileResponse í˜•íƒœë¡œ ë³€í™˜
        return UserProfileResponse(
            id=user.id,
            site_id=user.site_id,
            nickname=user.nickname,
            phone_number=user.phone_number,
            invite_code=user.invite_code,
            cyber_token_balance=user.cyber_token_balance,
            created_at=user.created_at,
            rank=user.rank,
            total_spent=getattr(user, 'total_spent', 0.0),
            vip_tier=getattr(user, 'vip_tier', 'STANDARD'),
            battlepass_level=getattr(user, 'battlepass_level', 1)
        )
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {str(e)}"
        )

@router.get("/segment", tags=["User Segmentation"])
async def get_user_segment(
    db: Session = Depends(get_db),
    current_user: models.User = Depends(get_current_user)
):
    """í˜„ì¬ ì‚¬ìš©ìì˜ ì„¸ê·¸ë¨¼íŠ¸ ì •ë³´ ì¡°íšŒ"""
    try:
        segment_service = UserSegmentService(db)
        segment_label = segment_service.get_segment_label(current_user.id)
        return {"user_id": current_user.id, "segment": segment_label}
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"ì„¸ê·¸ë¨¼íŠ¸ ì¡°íšŒ ì‹¤íŒ¨: {str(e)}"
        )

@router.get("/progress", response_model=UserProgressResponse, tags=["User Progress"])
async def get_user_progress(
    db: Session = Depends(get_db),
    current_user: models.User = Depends(get_current_user)
):
    """í˜„ì¬ ì‚¬ìš©ìì˜ ì§„í–‰ìƒí™© ì¡°íšŒ (ë ˆë²¨, ê²½í—˜ì¹˜, ë°°í‹€íŒ¨ìŠ¤ ë“±)"""
    try:
        # ì„ì‹œ ì§„í–‰ìƒí™© ë°ì´í„°
        return UserProgressResponse(
            user_id=current_user.id,
            level=1,
            experience=0,
            next_level_exp=100,
            progress_percentage=0.0
        )
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"ì§„í–‰ìƒí™© ì¡°íšŒ ì‹¤íŒ¨: {str(e)}"
        )

@router.get("/stats", tags=["User Statistics"])
async def get_user_statistics(
    db: Session = Depends(get_db),
    current_user: models.User = Depends(get_current_user)
):
    """í˜„ì¬ ì‚¬ìš©ìì˜ ê²Œì„ í†µê³„ ì¡°íšŒ"""
    try:
        user_service = UserService(db)
        stats = user_service.get_user_stats(current_user.id)
        return stats
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: {str(e)}"
        )

@router.delete("/account", tags=["Account Management"])
async def delete_user_account(
    current_user: models.User = Depends(get_current_user),
    user_service: UserService = Depends(get_user_service)
):
    """ì‚¬ìš©ì ê³„ì • ì‚­ì œ (ì†Œí”„íŠ¸ ì‚­ì œ)"""
    try:
        result = await user_service.soft_delete_user(current_user.id)
        return {"message": "ê³„ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "result": result}
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"ê³„ì • ì‚­ì œ ì‹¤íŒ¨: {str(e)}"
        )

# Admin endpoints (requires admin role)
@router.get("/admin/users", tags=["Admin - User Management"])
async def list_all_users(
    skip: int = 0,
    limit: int = 100,
    current_user: models.User = Depends(get_current_user),
    user_service: UserService = Depends(get_user_service)
):
    """ëª¨ë“  ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ (ê´€ë¦¬ì ì „ìš©)"""
    # TODO: Add admin role check
    try:
        users = await user_service.get_all_users(skip=skip, limit=limit)
        return users
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: {str(e)}"
        )

@router.get("/admin/users/{user_id}", tags=["Admin - User Management"])
async def get_user_by_id(
    user_id: int,
    current_user: models.User = Depends(get_current_user),
    user_service: UserService = Depends(get_user_service)
):
    """íŠ¹ì • ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ (ê´€ë¦¬ì ì „ìš©)"""
    # TODO: Add admin role check
    try:
        user = await user_service.get_user_by_id(user_id)
        if not user:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            )
        return user
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"ì‚¬ìš©ì ì¡°íšŒ ì‹¤íŒ¨: {str(e)}"
        )
